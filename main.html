<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>الرئيسية</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header">
    <span id="my-username" class="username"></span>
    <button id="logout">تسجيل الخروج</button>
  </div>

  <div class="search">
    <input type="text" id="search" placeholder="ابحث عن اسم المستخدم...">
    <button id="chat-btn">بدء المحادثة</button>
  </div>

  <h2>محادثاتك</h2>
  <div id="chat-with"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFPkNaiaExQZ6D3y0CKxIn6Pi0nrE9Fno",
      authDomain: "tawasal-431a8.firebaseapp.com",
      databaseURL: "https://tawasal-431a8-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tawasal-431a8",
      storageBucket: "tawasal-431a8.appspot.com",
      messagingSenderId: "81068658401",
      appId: "1:81068658401:web:b62d4e56a3cdf4108e31a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const uid = localStorage.getItem("uid");
    if (!uid) location.href = "index.html";

    const usernameSpan = document.getElementById("my-username");
    const logoutBtn = document.getElementById("logout");
    const searchInput = document.getElementById("search");
    const chatBtn = document.getElementById("chat-btn");
    const chatWithDiv = document.getElementById("chat-with");

    logoutBtn.onclick = () => {
      signOut(auth).then(() => {
        localStorage.clear();
        location.href = "index.html";
      });
    };

    async function getUsername(uid) {
      const snap = await get(ref(db, "users/" + uid));
      return snap.exists() ? snap.val().username : null;
    }

    async function displayChats() {
      const chatsSnap = await get(ref(db, "chats"));
      chatsSnap.forEach(async (childSnap) => {
        const chatId = childSnap.key;
        if (chatId.includes(uid)) {
          const [u1, u2] = chatId.split("_");
          const otherUID = u1 === uid ? u2 : u1;
          const otherName = await getUsername(otherUID);
          if (otherName) {
            const box = document.createElement("div");
            box.innerHTML = `@${otherName} <button onclick="location.href='chat.html?u=${otherUID}'">عرض المحادثة</button>`;
            chatWithDiv.appendChild(box);
          }
        }
      });
    }

    chatBtn.onclick = async () => {
      const name = searchInput.value.trim().replace("@", "");
      const isValid = /^[\u0621-\u064Aa-zA-Z0-9]{1,12}$/.test(name);
      if (!isValid) return alert("الاسم غير صالح");

      const usersSnap = await get(ref(db, "users"));
      let found = false;
      usersSnap.forEach((childSnap) => {
        if (childSnap.val().username === name) {
          location.href = "chat.html?u=" + childSnap.key;
          found = true;
        }
      });
      if (!found) alert("المستخدم غير موجود");
    };

    get(ref(db, "users/" + uid)).then((snap) => {
      if (snap.exists()) {
        usernameSpan.textContent = "@" + snap.val().username;
        usernameSpan.onclick = () => {
          navigator.clipboard.writeText(snap.val().username);
          alert("تم نسخ اسم المستخدم");
        };
      }
    });

    displayChats();
  </script>
</body>
</html>
