<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>الرئيسية - واتساب محمد</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="header">
    <span id="my-username" class="username" title="اضغط للنسخ"></span>
    <button id="logout">تسجيل الخروج</button>
  </div>

  <div class="search-box">
    <input type="text" id="search" placeholder="أدخل اسم المستخدم..." />
    <button id="chat-btn">بدء محادثة</button>
  </div>

  <h2>محادثاتك</h2>
  <div id="chat-with"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      get,
      child,
    } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";
    import {
      getAuth,
      signOut,
    } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFPkNaiaExQZ6D3y0CKxIn6Pi0nrE9Fno",
      authDomain: "tawasal-431a8.firebaseapp.com",
      databaseURL: "https://tawasal-431a8-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tawasal-431a8",
      storageBucket: "tawasal-431a8.appspot.com",
      messagingSenderId: "81068658401",
      appId: "1:81068658401:web:b62d4e56a3cdf4108e31a0",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const uid = localStorage.getItem("uid");
    const chatWithDiv = document.getElementById("chat-with");
    const searchInput = document.getElementById("search");
    const chatBtn = document.getElementById("chat-btn");
    const myUsernameSpan = document.getElementById("my-username");
    const logoutBtn = document.getElementById("logout");

    if (!uid) location.href = "index.html";

    logoutBtn.onclick = () => {
      signOut(auth).then(() => {
        localStorage.clear();
        location.href = "index.html";
      });
    };

    function isValidUsername(name) {
      const pattern = /^[\u0621-\u064A\u0660-\u0669a-zA-Z0-9]{1,12}$/;
      return pattern.test(name);
    }

    async function loadUserInfo() {
      const snap = await get(ref(db, "users/" + uid));
      if (snap.exists()) {
        const username = snap.val().username;
        myUsernameSpan.textContent = "@" + username;
        myUsernameSpan.onclick = () => {
          navigator.clipboard.writeText(username);
          alert("تم نسخ اسم المستخدم");
        };
      }
    }

    async function loadChats() {
      const snap = await get(ref(db, "chats"));
      snap.forEach(async (childSnap) => {
        const chatId = childSnap.key;
        if (chatId.includes(uid)) {
          const [u1, u2] = chatId.split("_");
          const otherUID = u1 === uid ? u2 : u1;
          const otherSnap = await get(ref(db, "users/" + otherUID));
          if (otherSnap.exists()) {
            const otherName = otherSnap.val().username;
            const box = document.createElement("div");
            box.innerHTML = `
              <span class="chat-username">@${otherName}</span>
              <button onclick="location.href='chat.html?u=${otherUID}'">عرض المحادثة</button>
            `;
            chatWithDiv.appendChild(box);
          }
        }
      });
    }

    chatBtn.addEventListener("click", async () => {
      const name = searchInput.value.trim().replace("@", "");
      if (!isValidUsername(name)) {
        alert("اسم المستخدم غير صالح");
        return;
      }

      const snap = await get(child(ref(db), "users"));
      let found = false;
      snap.forEach((childSnap) => {
        if (childSnap.val().username === name) {
          const otherUID = childSnap.key;
          location.href = `chat.html?u=${otherUID}`;
          found = true;
        }
      });
      if (!found) alert("المستخدم غير موجود");
    });

    loadUserInfo();
    loadChats();
  </script>
</body>
</html>
