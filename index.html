<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تسجيل الدخول</title>
</head>
<body>
  <h1>مرحبًا بك في تطبيق التواصل</h1>
  <button id="login-btn">تسجيل الدخول بجوجل</button>

  <div id="username-container" style="display:none;">
    <p>اختر اسم مستخدم:</p>
    <input type="text" id="username-input" placeholder="اكتب اسمك">
    <button id="save-username-btn">متابعة</button>
  </div>

  <script type="module">
    import { auth, provider, db } from "./firebase.js";
    import { signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";

    const loginBtn = document.getElementById("login-btn");
    const usernameContainer = document.getElementById("username-container");
    const usernameInput = document.getElementById("username-input");
    const saveUsernameBtn = document.getElementById("save-username-btn");

    loginBtn.addEventListener("click", () => {
      signInWithPopup(auth, provider)
        .then((result) => {
          checkUsername(result.user.uid);
        });
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        checkUsername(user.uid);
      }
    });

    function checkUsername(uid) {
      const userRef = ref(db, "users/" + uid);
      get(userRef).then((snapshot) => {
        if (snapshot.exists() && snapshot.val().username) {
          localStorage.setItem("uid", uid);
          window.location.href = "main.html";
        } else {
          usernameContainer.style.display = "block";
        }
      });
    }

    saveUsernameBtn.addEventListener("click", () => {
      const username = usernameInput.value.trim();
      const uid = auth.currentUser.uid;

      if (username !== "") {
        const usersRef = ref(db, "usernames/" + username);
        get(usersRef).then((snapshot) => {
          if (snapshot.exists()) {
            alert("الاسم مستخدم بالفعل، اختر اسم آخر.");
          } else {
            set(ref(db, "usernames/" + username), uid);
            set(ref(db, "users/" + uid), {
              username: username
            }).then(() => {
              localStorage.setItem("uid", uid);
              window.location.href = "main.html";
            });
          }
        });
      }
    });
  </script>
</body>
</html>
